name: Bazel coverage
on: [pull_request]

jobs:
  coverage:
    name: Run
    strategy:
      matrix:
        worker: [c7n_azure_cov, c7n_gcp_cov, c7n_kube_cov, c7n_mailer_cov]
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build a docker image with bazel
        run: docker build -f Docker-bazel-exec -t my-baz .
      - name: Run a container with the image
        run: docker run -dit -v /tmp/output_build:/tmp/output_build -v /tmp/C7N-cov:/tmp/C7N-cov --name baz my-baz
      - name: Execute bazel coverage //tools/c7n_azure/tests_azure
        if: matrix.worker == 'c7n_azure_cov'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build coverage //tools/c7n_azure/tests_azure:test_tags
      - name: Execute bazel coverage //tools/c7n_gcp/tests
        if: matrix.worker == 'c7n_gcp_cov'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build coverage //tools/c7n_gcp/tests:test_dns
      - name: Execute bazel coverage //tools/c7n_kube/tests
        if: matrix.worker == 'c7n_kube_cov'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build coverage //tools/c7n_kube/tests:test_labels
      - name: Execute bazel coverage //tools/c7n_mailer/tests
        if: matrix.worker == 'c7n_mailer_cov'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build coverage //tools/c7n_mailer/tests:test_utils
      - name: Upload coverage results for //tools/c7n_azure/tests_azure
        if: matrix.worker == 'c7n_azure_cov'
        uses: actions/upload-artifact@v1
        with:
          name: c7n_azure_cov_result
          path: /tmp/C7N-cov/tools.c7n_azure.tests_azure/
      - name: Upload coverage results for //tools/c7n_gcp/tests
        if: matrix.worker == 'c7n_gcp_cov'
        uses: actions/upload-artifact@v1
        with:
          name: c7n_gcp_cov_result
          path: /tmp/C7N-cov/tools.c7n_gcp.tests/
      - name: Upload coverage results for //tools/c7n_kube/tests
        if: matrix.worker == 'c7n_kube_cov'
        uses: actions/upload-artifact@v1
        with:
          name: c7n_kube_cov_result
          path: /tmp/C7N-cov/tools.c7n_kube.tests/
      - name: Upload coverage results for //tools/c7n_mailer/tests
        if: matrix.worker == 'c7n_mailer_cov'
        uses: actions/upload-artifact@v1
        with:
          name: c7n_mailer_cov_result
          path: /tmp/C7N-cov/tools.c7n_mailer.tests/
  report:
    name: Generate coverage report
    needs: coverage
    runs-on: ubuntu-18.04
    steps:
      - name: Download coverage results for //tools/c7n_azure/tests_azure
        uses: actions/download-artifact@v1
        with:
          name: c7n_azure_cov_result
          path: /tmp
      - name: Download coverage results for //tools/c7n_gcp/tests
        uses: actions/download-artifact@v1
        with:
          name: c7n_gcp_cov_result
          path: /tmp
      - name: Download coverage results for //tools/c7n_kube/tests
        uses: actions/download-artifact@v1
        with:
          name: c7n_kube_cov_result
          path: /tmp
      - name: Download coverage results for //tools/c7n_mailer/tests
        uses: actions/download-artifact@v1
        with:
          name: c7n_mailer_cov_result
          path: /tmp
      - name: Generate HTML coverage report
        run: |
          ls /tmp
          unzip /tmp/c7n_azure_cov_result
          unzip /tmp/c7n_gcp_cov_result
          unzip /tmp/c7n_kube_cov_result
          unzip /tmp/c7n_mailer_cov_result
          ls
          coverage combine
          coverage html -d htmlcov
      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v1
        with:
          name: HTML coverage report
          path: htmlcov