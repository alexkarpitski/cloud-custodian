name: Run checks in bazel
on: [pull_request]

jobs:
  build:
    name: Run
    strategy:
      matrix:
        worker: [c7n_tests_first, c7n_tests_second, c7n_azure_tests, c7n_gcp_tests, c7n_kube_tests, c7n_mailer_tests,
                 c7n_cov_first, c7n_cov_second, c7n_azure_cov, c7n_gcp_cov, c7n_kube_cov, c7n_mailer_cov,
                 c7n_wheel, c7n_azure_wheel, c7n_gcp_wheel, c7n_kube_wheel, c7n_mailer_wheel,
                 c7n_sphinx]
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build a docker image with bazel
        run: docker build -f Docker-bazel-exec -t my-baz .
      - name: Run a container with the image
        run: docker run -dit -v /tmp/output_build:/tmp/output_build -v /tmp/C7N-cov:/tmp/C7N-cov --name baz my-baz
      - name: Execute bazel test //tests:first_chunk
        if: matrix.worker == 'c7n_tests_first'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build test //tests:first_chunk
      - name: Execute bazel test //tests:second_chunk
        if: matrix.worker == 'c7n_tests_second'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build test //tests:second_chunk
      - name: Execute bazel test //tools/c7n_azure/tests_azure
        if: matrix.worker == 'c7n_azure_tests'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build test //tools/c7n_azure/tests_azure
      - name: Execute bazel test //tools/c7n_gcp/tests
        if: matrix.worker == 'c7n_gcp_tests'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build test //tools/c7n_gcp/tests
      - name: Execute bazel test //tools/c7n_kube/tests
        if: matrix.worker == 'c7n_kube_tests'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build test //tools/c7n_kube/tests
      - name: Execute bazel test //tools/c7n_mailer/tests
        if: matrix.worker == 'c7n_mailer_tests'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build test //tools/c7n_mailer/tests
      - name: Execute bazel coverage //tests:first_chunk
        if: matrix.worker == 'c7n_cov_first'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build coverage //tests:first_chunk
      - name: Execute bazel coverage //tests:second_chunk
        if: matrix.worker == 'c7n_cov_second'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build coverage //tests:second_chunk
      - name: Execute bazel coverage //tools/c7n_azure/tests_azure
        if: matrix.worker == 'c7n_azure_cov'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build coverage //tools/c7n_azure/tests_azure
      - name: Execute bazel coverage //tools/c7n_gcp/tests
        if: matrix.worker == 'c7n_gcp_cov'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build coverage //tools/c7n_gcp/tests
      - name: Execute bazel coverage //tools/c7n_kube/tests
        if: matrix.worker == 'c7n_kube_cov'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build coverage //tools/c7n_kube/tests
      - name: Execute bazel coverage //tools/c7n_mailer/tests
        if: matrix.worker == 'c7n_mailer_cov'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build coverage //tools/c7n_mailer/tests
      - name: Execute bazel build //:c7n_wheel
        if: matrix.worker == 'c7n_wheel'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build build c7n_wheel
      - name: Execute bazel build //:c7n_azure_wheel
        if: matrix.worker == 'c7n_azure_wheel'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build build c7n_azure_wheel
      - name: Execute bazel build //:c7n_gcp_wheel
        if: matrix.worker == 'c7n_gcp_wheel'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build build c7n_gcp_wheel
      - name: Execute bazel build //:c7n_kube_wheel
        if: matrix.worker == 'c7n_kube_wheel'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build build c7n_kube_wheel
      - name: Execute bazel build //:c7n_mailer_wheel
        if: matrix.worker == 'c7n_mailer_wheel'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build build c7n_mailer_wheel
      - name: Execute bazel build //tools/c7n_sphinxext/c7n_sphinxext:sphinx_gen
        if: matrix.worker == 'c7n_sphinx'
        run: docker exec -t baz bazel --output_user_root=/tmp/output_build build //tools/c7n_sphinxext/c7n_sphinxext:sphinx_gen
      - name: Generate coverage report
        run: |
          docker exec -t baz pip3 install coverage
          docker exec -t baz find /tmp/C7N-cov -type f -name '.coverage*' -exec cp -at /tmp/C7N-cov {} +; \
          docker exec -t baz coverage combine /tmp/C7N-cov/; \
          docker exec -t baz coverage html -d /tmp/C7N-cov/htmlcov
          docker exec -t baz coverage xml -o /tmp/C7N-cov/coverage.xml
      - name: Generate artifact for HTML coverage report
        uses: actions/upload-artifact@v1
        with:
          name: HTML coverage report
          path: /tmp/C7N-cov/htmlcov
      - name: Generate artifact for XML coverage report
        uses: actions/upload-artifact@v1
        with:
          name: XML coverage report
          path: /tmp/C7N-cov/coverage.xml